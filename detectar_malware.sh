#!/bin/bash

# Script para detectar malware (xmrig, systemd-devd) en el servidor
# Ejecutar con: bash detectar_malware.sh

echo "=========================================="
echo "üîç DETECCI√ìN DE MALWARE - s1mple_cloud"
echo "=========================================="
echo ""

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 1. Buscar procesos relacionados con xmrig
echo -e "${YELLOW}[1] Buscando procesos xmrig...${NC}"
XMrig_PROCESSES=$(ps aux | grep -i xmrig | grep -v grep)
if [ -z "$XMrig_PROCESSES" ]; then
    echo -e "${GREEN}‚úì No se encontraron procesos xmrig${NC}"
else
    echo -e "${RED}‚ö†Ô∏è PROCESOS XMRIG ENCONTRADOS:${NC}"
    echo "$XMrig_PROCESSES"
fi
echo ""

# 2. Buscar procesos relacionados con systemd-devd
echo -e "${YELLOW}[2] Buscando procesos systemd-devd...${NC}"
DEVD_PROCESSES=$(ps aux | grep -i "systemd-devd" | grep -v grep)
if [ -z "$DEVD_PROCESSES" ]; then
    echo -e "${GREEN}‚úì No se encontraron procesos systemd-devd${NC}"
else
    echo -e "${RED}‚ö†Ô∏è PROCESOS SYSTEMD-DEVD ENCONTRADOS:${NC}"
    echo "$DEVD_PROCESSES"
fi
echo ""

# 3. Buscar archivos xmrig en el sistema
echo -e "${YELLOW}[3] Buscando archivos xmrig en el sistema...${NC}"
XMrig_FILES=$(find / -name "*xmrig*" -type f 2>/dev/null | head -20)
if [ -z "$XMrig_FILES" ]; then
    echo -e "${GREEN}‚úì No se encontraron archivos xmrig${NC}"
else
    echo -e "${RED}‚ö†Ô∏è ARCHIVOS XMRIG ENCONTRADOS:${NC}"
    echo "$XMrig_FILES"
fi
echo ""

# 4. Buscar archivos systemd-devd
echo -e "${YELLOW}[4] Buscando archivos systemd-devd...${NC}"
DEVD_FILES=$(find / -name "*systemd-devd*" -type f 2>/dev/null | head -20)
if [ -z "$DEVD_FILES" ]; then
    echo -e "${GREEN}‚úì No se encontraron archivos systemd-devd${NC}"
else
    echo -e "${RED}‚ö†Ô∏è ARCHIVOS SYSTEMD-DEVD ENCONTRADOS:${NC}"
    echo "$DEVD_FILES"
fi
echo ""

# 5. Revisar servicios systemd sospechosos
echo -e "${YELLOW}[5] Revisando servicios systemd...${NC}"
SUSPICIOUS_SERVICES=$(systemctl list-units --type=service --all | grep -iE "devd|miner|xmrig" 2>/dev/null)
if [ -z "$SUSPICIOUS_SERVICES" ]; then
    echo -e "${GREEN}‚úì No se encontraron servicios sospechosos${NC}"
else
    echo -e "${RED}‚ö†Ô∏è SERVICIOS SOSPECHOSOS ENCONTRADOS:${NC}"
    echo "$SUSPICIOUS_SERVICES"
fi
echo ""

# 6. Revisar crontab por tareas sospechosas
echo -e "${YELLOW}[6] Revisando crontab...${NC}"
CRON_JOBS=$(crontab -l 2>/dev/null | grep -iE "xmrig|systemd-devd|miner|curl.*bash|wget.*bash")
if [ -z "$CRON_JOBS" ]; then
    echo -e "${GREEN}‚úì No se encontraron trabajos cron sospechosos${NC}"
else
    echo -e "${RED}‚ö†Ô∏è TRABAJOS CRON SOSPECHOSOS ENCONTRADOS:${NC}"
    echo "$CRON_JOBS"
fi
echo ""

# 7. Revisar /etc/crontab
echo -e "${YELLOW}[7] Revisando /etc/crontab...${NC}"
if [ -f /etc/crontab ]; then
    SYSTEM_CRON=$(grep -iE "xmrig|systemd-devd|miner" /etc/crontab 2>/dev/null)
    if [ -z "$SYSTEM_CRON" ]; then
        echo -e "${GREEN}‚úì /etc/crontab limpio${NC}"
    else
        echo -e "${RED}‚ö†Ô∏è ENTRADAS SOSPECHOSAS EN /etc/crontab:${NC}"
        echo "$SYSTEM_CRON"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è /etc/crontab no existe${NC}"
fi
echo ""

# 8. Revisar conexiones de red sospechosas
echo -e "${YELLOW}[8] Revisando conexiones de red...${NC}"
NET_CONNECTIONS=$(netstat -tulpn 2>/dev/null | grep -iE "LISTEN|ESTABLISHED" | grep -vE "127.0.0.1|::1")
if [ -z "$NET_CONNECTIONS" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è No se pudieron obtener conexiones de red (requiere permisos)${NC}"
else
    echo -e "${YELLOW}Conexiones activas:${NC}"
    echo "$NET_CONNECTIONS" | head -20
fi
echo ""

# 9. Buscar scripts bash sospechosos recientes
echo -e "${YELLOW}[9] Buscando scripts bash modificados recientemente...${NC}"
RECENT_SCRIPTS=$(find /home /tmp /var/tmp -name "*.sh" -mtime -7 -type f 2>/dev/null | head -10)
if [ -z "$RECENT_SCRIPTS" ]; then
    echo -e "${GREEN}‚úì No se encontraron scripts recientes${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è Scripts modificados en los √∫ltimos 7 d√≠as:${NC}"
    echo "$RECENT_SCRIPTS"
fi
echo ""

# 10. Revisar procesos con alto uso de CPU
echo -e "${YELLOW}[10] Procesos con alto uso de CPU (posibles mineros)...${NC}"
HIGH_CPU=$(ps aux --sort=-%cpu | head -10 | awk '{if($3 > 50.0) print $0}')
if [ -z "$HIGH_CPU" ]; then
    echo -e "${GREEN}‚úì No se encontraron procesos con uso de CPU > 50%${NC}"
else
    echo -e "${RED}‚ö†Ô∏è PROCESOS CON ALTO USO DE CPU:${NC}"
    echo "$HIGH_CPU"
fi
echo ""

# 11. Revisar archivos en /tmp y /var/tmp
echo -e "${YELLOW}[11] Revisando archivos ejecutables en /tmp y /var/tmp...${NC}"
TMP_EXECUTABLES=$(find /tmp /var/tmp -type f -executable 2>/dev/null | head -20)
if [ -z "$TMP_EXECUTABLES" ]; then
    echo -e "${GREEN}‚úì No se encontraron ejecutables en /tmp${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è Ejecutables encontrados en /tmp:${NC}"
    echo "$TMP_EXECUTABLES"
fi
echo ""

# 12. Revisar logs de acceso recientes
echo -e "${YELLOW}[12] √öltimas 20 l√≠neas de logs de acceso (si existen)...${NC}"
if [ -f /var/log/nginx/access.log ]; then
    echo -e "${YELLOW}Nginx access.log:${NC}"
    tail -20 /var/log/nginx/access.log | grep -iE "DELETE|POST.*bastian" || echo "No se encontraron peticiones sospechosas"
elif [ -f ./logs/pm2-out.log ]; then
    echo -e "${YELLOW}PM2 logs:${NC}"
    tail -20 ./logs/pm2-out.log
else
    echo -e "${YELLOW}‚ö†Ô∏è No se encontraron logs de acceso${NC}"
fi
echo ""

echo "=========================================="
echo "‚úÖ An√°lisis completado"
echo "=========================================="
echo ""
echo "Si encontraste procesos o archivos sospechosos:"
echo "1. NO los elimines inmediatamente (podr√≠a alertar al atacante)"
echo "2. Documenta todo (screenshots, logs)"
echo "3. A√≠sla el servidor de la red si es posible"
echo "4. Contacta a un experto en seguridad"
echo "5. Revisa ANALISIS_SEGURIDAD.md para m√°s informaci√≥n"

